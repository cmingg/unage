<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"></head>

<body>
<header th:replace="fragments/header :: header"></header>
<h1>JOIN US</h1>
<form method="post" th:action="@{/member/join}" id="loginForm">
    <div class="form-group">
        <label for="userName">이름</label>
        <input type="text" id="userName" name="userName">
        <span class="error_box"></span>
    </div>
    <div class="form-group">
        <label for="userId">아이디</label>
        <input type="text" id="userId" name="userId" maxlength="16">
        <span class="error_box"></span>
    </div>
    <div class="form-group">
        <label for="pwd">비밀번호</label>
        <input type="password" id="pwd" name="pwd" maxlength="16">
        <span class="error_box"></span>
    </div>
    <div class="form-group">
        <label for="checkPwd">비밀번호 확인</label>
        <input type="password" id="checkPwd" name="checkPwd">
        <span class="error_box"></span>
    </div>
    <div class="form-group">
        <label for="zonecode">주소</label>
        <input type="text" id="zonecode" placeholder="우편번호" name="address">
        <input type="button" onclick="kakaopost()" value="우편번호 찾기" readonly><br>
        <input type="text" id="address" name="address" placeholder="주소">
        <input type="text" id="detailAddress" placeholder="상세주소" name="address">
        <span class="error_box"></span>
    </div>
    <div class="form-group">
        <label for="phone">휴대전화</label>
        <input type="text" id="phone" name="phone" maxlength="13" placeholder="'-' 제외 숫자만 입력해주세요.">
        <span class="error_box"></span>
    </div>
    <div class="form-group">
        <label for="email">이메일</label>
        <input type="email" id="email" name="email" placeholder="@까지 정확하게 입력해주세요." maxlength="50">
        <span class="error_box"></span>
    </div>
    <input type="button" name="btnJoin" id="btnJoin" value="REGISTER"/>
    <input type="reset" value="RESET">
</form>
<footer th:replace="fragments/footer :: footer"></footer>
</body>

<script th:inline="javascript">

    let error = document.querySelectorAll(".error_box");
    let idStatus = false;
    let emailStatus = false;

    $(document).ready(function () {
        $('#userName').blur(function () {
            checkName();
        });
        $('#userId').blur(function () {
            checkId();
        });
        $('#pwd').blur(function () {
            checkPwd();
            comparePwd();
        });

        $('#checkPwd').blur(function () {
            comparePwd();
        });

        $('#address').blur(function () {
            checkAddress();
        });
        $('#phone').blur(function () {
            checkPhone();
        });
        $('#email').blur(function () {
            checkEmail();
        });
        $(document).on("keyup", "#phone", function () {
            $(this).val($(this).val().replace(/[^0-9]/g, "").replace(/(^02|^0505|^1[0-9]{3}|^0[0-9]{2})([0-9]+)?([0-9]{4})$/, "$1-$2-$3").replace("--", "-"));
        });
    });

    function checkName() {
        var userName = $("#userName").val();
        var namePattern = /^[가-힣a-zA-Z]+$/;

        if (userName === "") {
            error[0].innerHTML = "필수 정보입니다.";
            error[0].style.color = "red";
            error[0].style.display = "block";   // 요소 앞뒤 줄바꿈
            return false;
        } else if (!namePattern.test(userName)) {
            error[0].innerHTML = "한글과 영문 대/소문자를 사용하세요.";
            error[0].style.color = "red";
            error[0].style.display = "block";
            return false;
        } else {
            console.log("이름");
            error[0].style.display = "none";
            return true;
        }
    }

    function checkId() {
        var userId = $("#userId").val();
        var idPattern = /^[a-z0-9]{4,16}$/;

        if (userId === "") {
            error[1].innerHTML = "필수 정보입니다.";
            error[1].style.color = "red";
            error[1].style.display = "block";
            idStatus = false;
        } else if (!idPattern.test(userId)) {
            error[1].innerHTML = "4~16자의 영문 소문자, 숫자만 사용 가능합니다.";
            error[1].style.color = "red";
            error[1].style.display = "block";
            idStatus = false;
        } else {
            $.ajax({
                url: "/member/idCheck",
                type: "GET",
                data: {id: userId},
                success: function (data) {
                    if (data === false) {
                        console.log("아이디");
                        error[1].innerHTML = "사용 가능한 아이디입니다!";
                        error[1].style.color = "green";
                        error[1].style.display = "block";
                        idStatus = true;
                    } else {
                        error[1].innerHTML = "이미 존재하는 아이디입니다!";
                        error[1].style.color = "red";
                        error[1].style.display = "block";
                        idStatus = false;
                    }
                }, error: function () {
                    console.log("실패");
                }
            });
        }
    }

    function checkPwd() {
        var pwd = $("#pwd").val();
        var pwdPattern = /[a-zA-Z0-9~!@#$%^&*()_+|<>?:{}]{8,16}$/;

        if (pwd === "") {
            error[2].innerHTML = "필수 정보입니다.";
            error[2].style.color = "red";
            error[2].style.display = "block";
            return false;
        } else if (!pwdPattern.test(pwd)) {
            error[2].innerHTML = "8~16자 영문 대/소문자, 숫자, 특수문자를 사용하세요.";
            error[2].style.color = "red";
            error[2].style.display = "block";
            return false;
        } else {
            console.log("비밀번호1");
            error[2].style.display = "none";
            return true;
        }
    }

    function comparePwd() {
        var pwd1 = $("#pwd").val();
        var pwd2 = $("#checkPwd").val();

        if (pwd2 === "") {
            error[3].innerHTML = "필수 정보입니다.";
            error[3].style.color = "red";
            error[3].style.display = "block";
            return false;
        }
        if (pwd1 !== pwd2) {
            error[3].innerHTML = "비밀번호가 일치하지 않습니다.";
            error[3].style.color = "red";
            error[3].style.display = "block";
            return false;
        } else if (pwd1 === pwd2 && pwd2 !== "") {
            console.log("비밀번호2");
            error[3].innerHTML = "비밀번호가 일치합니다.";
            error[3].style.color = "green";
            error[3].style.display = "block";
            return true;
        }
    }

    function checkAddress() {
        var address = $("#address").val();

        if (address === "") {
            error[4].innerHTML = "필수 정보입니다.";
            error[4].style.color = "red";
            error[4].style.display = "block";
            return false;
        } else {
            console.log("주소");
            error[4].style.display = "none";
            return true;
        }
    }

    function checkPhone() {
        var phone = $("#phone").val();
        var phonePattern = /^[0-9]{2,3}-[0-9]{3,4}-[0-9]{4}$/;

        if (phone === "") {
            error[5].innerHTML = "필수 정보입니다.";
            error[5].style.color = "red";
            error[5].style.display = "block";
            return false;
        } else if (!phonePattern.test(phone)) {
            error[5].innerHTML = "형식에 맞지 않는 번호입니다.";
            error[5].style.color = "red";
            error[5].style.display = "block";
            return false;
        } else {
            console.log("전화번호");
            error[5].style.display = "none";
            return true;
        }
    }

    function checkEmail() {
        var email = $("#email").val();
        var emailPattern = /^[a-zA-Z0-9]([-_.]?[a-zA-Z0-9])*@[a-zA-Z0-9]([-_.]?[a-zA-Z0-9])*.[a-zA-Z]{2,3}$/i;

        if (email === "") {
            error[6].innerHTML = "필수 정보입니다.";
            error[6].style.color = "red";
            error[6].style.display = "block";
            emailStatus = false;
        } else if (!emailPattern.test(email)) {
            error[6].innerHTML = "형식에 맞지 않는 이메일입니다.";
            error[6].style.color = "red";
            error[6].style.display = "block";
            emailStatus = false;
        } else {
            $.ajax({
                url: "/member/emailCheck",
                type: "GET",
                data: {email: email},
                success: function (data) {
                    if (data === false) {
                        console.log("이메일");
                        error[6].innerHTML = "사용 가능한 이메일입니다!";
                        error[6].style.color = "green";
                        error[6].style.display = "block";
                        emailStatus = true;
                    } else {
                        error[6].innerHTML = "이미 존재하는 이메일입니다!";
                        error[6].style.color = "red";
                        error[6].style.display = "block";
                        emailStatus = false;
                    }
                }, error: function () {
                    console.log("실패");
                }
            });
        }
    }

    // 카카오 주소찾기
    function kakaopost() {
        new daum.Postcode({
            oncomplete: function (data) { //선택시 입력값 세팅
                document.getElementById('zonecode').value = data.zonecode;
                document.getElementById("address").value = data.address; // 주소 넣기
                document.getElementById('detailAddress').focus(); //상세입력 포커싱
            }
        }).open();
    }

    $("#btnJoin").click(function () {

        let nameStatus = checkName();
        let pwdStatus = checkPwd();
        let checkPwdStatus = comparePwd();
        let addressStatus = checkAddress();
        let phoneStatus = checkPhone();
        checkId();
        checkEmail();

        if (!nameStatus) {
            $('#userName').focus();
            return;
        } else if (!idStatus) {
            $('#userId').focus();
            return;
        } else if (!pwdStatus) {
            $('#pwd').focus();
            return;
        } else if (!checkPwdStatus) {
            $('#checkPwd').focus();
            return;
        } else if (!addressStatus) {
            $('#zonecode').focus();
            return;
        } else if (!phoneStatus) {
            $('#phone').focus();
            return;
        } else if (!emailStatus) {
            $('#email').focus();
            return;
        }
        $('#loginForm').submit();
    });
</script>
</html>
